# yaml-language-server: $schema=https://raw.githubusercontent.com/bjw-s/helm-charts/app-template-4.6.2/charts/other/app-template/schemas/helmrelease-helm-v2.schema.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: shlink
  namespace: shlink
spec:
  chart:
    spec:
      chart: app-template
      version: 4.6.2
      reconcileStrategy: ChartVersion
      sourceRef:
        kind: HelmRepository
        namespace: flux-system
        name: bjw-s
  interval: 1h
  driftDetection:
    mode: enabled
  values:
    controllers:
      api:
        strategy: RollingUpdate
        initContainers:
          geoip:
            image: &image
              repository: ghcr.io/shlinkio/shlink
              tag: 4.6.0-roadrunner@sha256:5d4f139f71d8734cc27c33bac4a4a14f1b8dd39aad4ba822e85015ff575edecb
              pullPolicy: IfNotPresent
            command:
              - sh
              - -c
              - |
                set -eux
                cp -a ./vendor/shlinkio/shlink-ip-geolocation/src/GeoLite2/* /geoip
                sed -i 's|https://download.maxmind.com|http://geoip-download.geoip|' \
                  /geoip/GeoLite2Options.php
        containers:
          app:
            image: *image

            env:
              TZ: America/Chicago
              DEFAULT_DOMAIN: ${app_url}
              SHORT_DOMAIN_HOST: ${app_url}
              SHORT_DOMAIN_SCHEMA: https
              VALIDATE_URLS: "true"
              ANONYMIZE_REMOTE_ADDR: "false"
              ENABLE_PERIODIC_VISIT_LOCATE: "true"
              # AUTO_RESOLVE_TITLES: "true"
              GEOLITE_LICENSE_KEY: stub

              DB_DRIVER: postgres
              DB_HOST: postgresql-rw
              DB_NAME: shlink
              DB_USER: shlink
              DB_PASSWORD:
                secretKeyRef:
                  name: postgresql-app
                  key: password

              WEB_WORKER_NUM: "4"
              TASK_WORKER_NUM: "4"

              SKIP_INITIAL_GEOLITE_DOWNLOAD: "true"
            securityContext:
              readOnlyRootFilesystem: true
        pod:
          labels:
            policy.gabe565.com/egress-geoip: "true"
            policy.gabe565.com/egress-namespace: "true"
            policy.gabe565.com/egress-world: "true"
            policy.gabe565.com/ingress-envoy-public: "true"
          terminationGracePeriodSeconds: 1
      frontend:
        strategy: RollingUpdate
        containers:
          app:
            image:
              repository: ghcr.io/shlinkio/shlink-web-client
              tag: 4.7.0@sha256:80b4d00c445f61e38164a4f13bea4f915b0bdc051e74705fe21ffa92a3d6fed5
              pullPolicy: IfNotPresent
            securityContext:
              readOnlyRootFilesystem: true
        pod:
          labels:
            policy.gabe565.com/ingress-envoy-public: "true"

    persistence:
      data:
        type: emptyDir
        advancedMounts:
          api:
            app:
              - path: /etc/shlink/data
      tmp:
        type: emptyDir
        medium: Memory
        sizeLimit: 128Mi
      geolite2:
        type: emptyDir
        advancedMounts:
          api:
            geoip:
              - path: /geoip
            app:
              - path: /etc/shlink/vendor/shlinkio/shlink-ip-geolocation/src/GeoLite2
                readOnly: true

    service:
      api:
        controller: api
        ports:
          http:
            port: 8080
      frontend:
        controller: frontend
        ports:
          http:
            port: 8080

    route:
      api:
        parentRefs: &parentRefs
          - namespace: envoy-gateway-system
            name: envoy-public
        hostnames:
          - ${app_url}
        rules:
          - backendRefs:
              - identifier: api
      frontend:
        parentRefs: *parentRefs
        hostnames:
          - ${admin_url}
        rules:
          - name: private
            backendRefs:
              - identifier: frontend
          - name: servers-json
            matches:
              - path:
                  type: Exact
                  value: /servers.json
            backendRefs:
              - identifier: frontend
          - name: service-worker
            matches:
              - path:
                  type: Exact
                  value: /service-worker.js
            filters:
              - type: ExtensionRef
                extensionRef:
                  group: gateway.envoyproxy.io
                  kind: HTTPRouteFilter
                  name: shlink-service-worker

    rawResources:
      auth:
        apiVersion: gateway.envoyproxy.io/v1alpha1
        kind: SecurityPolicy
        spec:
          spec:
            targetRefs:
              - group: gateway.networking.k8s.io
                kind: HTTPRoute
                name: "{{ .Release.Name }}-frontend"
                sectionName: private
              - group: gateway.networking.k8s.io
                kind: HTTPRoute
                name: "{{ .Release.Name }}-frontend"
                sectionName: servers-json
            oidc:
              provider:
                issuer: https://${oidc_host}/application/o/shlink/
              clientIDRef:
                name: oidc
              clientSecret:
                name: oidc
              scopes:
                - openid
                - offline_access
                - shlink:token
              forwardAccessToken: true
            jwt:
              optional: true
              providers:
                - name: extract-user-info
                  remoteJWKS:
                    uri: https://${oidc_host}/application/o/shlink/jwks/
                  claimToHeaders:
                    - claim: shlink_token
                      header: X-Shlink-Token
      servers-json:
        apiVersion: gateway.envoyproxy.io/v1alpha1
        kind: EnvoyExtensionPolicy
        spec:
          spec:
            targetRefs:
              - group: gateway.networking.k8s.io
                kind: HTTPRoute
                name: "{{ .Release.Name }}-frontend"
                sectionName: servers-json
            lua:
              - type: Inline
                # language=lua
                inline: |
                  function envoy_on_request(handle)
                    local api_key = handle:headers():get("x-shlink-token")
                    if api_key then
                       local json_body = '[{"name":"${app_url}", "url":"https://${app_url}", "apiKey":"' .. api_key .. '"}]'
                       handle:respond(
                          {[":status"] = "200", ["content-type"] = "application/json"},
                          json_body
                       )
                    end
                  end
      service-worker:
        apiVersion: gateway.envoyproxy.io/v1alpha1
        kind: HTTPRouteFilter
        spec:
          spec:
            directResponse:
              contentType: application/javascript
              statusCode: 200
              body:
                type: Inline
                inline: |
                  self.addEventListener('install', event => { event.waitUntil(self.skipWaiting()) });
